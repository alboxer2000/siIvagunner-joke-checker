<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiIvaGunner Joke Checker</title>
    <!-- Use the Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a clean, modern look */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Basic modal styles for the editor */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
    </style>
    <!-- Add Font Awesome for the sun/moon icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- Main application container -->
    <div class="relative bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-2xl text-center">

        <!-- Title and instructions -->
        <h1 class="text-3xl sm:text-4xl font-extrabold text-sky-400 mb-2">SiIvaGunner Joke Identifier</h1>
        <p class="text-slate-400 mb-6">Enter a video ID or exact title to see if its primary joke has been identified.</p>

        <!-- Input field and check button -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <input 
                id="videoIdInput" 
                type="text" 
                placeholder="Enter a video ID or exact title..." 
                class="flex-grow p-3 rounded-lg bg-slate-700 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all"
            >
            <button 
                id="checkButton" 
                class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-sky-500"
            >
                Check Video
            </button>
        </div>

        <!-- Result display area -->
        <div 
            id="resultDisplay" 
            class="text-lg font-semibold text-center p-4 rounded-lg transition-all duration-300"
        >
            <!-- Results will be displayed here -->
        </div>

        <!-- Button to open the JSON editor, initially hidden -->
        <button 
            id="editorButton" 
            class="mt-8 bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-slate-500 hidden"
        >
            Open JSON Editor
        </button>

    </div>

    <!-- JSON Editor Modal -->
    <div id="jsonEditorModal" class="modal">
        <div class="modal-content bg-slate-800">
            <h2 class="text-2xl font-bold text-sky-400 mb-4">Edit `jokes.json`</h2>
            <textarea 
                id="jsonEditorTextarea" 
                class="w-full h-80 p-4 rounded-lg bg-slate-700 text-white font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-sky-500"
            ></textarea>
            <div class="flex justify-end gap-4 mt-4">
                <button 
                    id="saveButton" 
                    class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105"
                >
                    Save Changes
                </button>
                <button 
                    id="closeButton" 
                    class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105"
                >
                    Close
                </button>
            </div>
            <p id="editorMessage" class="mt-4 text-sm text-red-400"></p>
        </div>
    </div>
    
    <script>
        // Use an IIFE (Immediately Invoked Function Expression) to avoid global scope pollution.
        (function() {

            // === 1. Data Source ===
            // The URL for the jokes.json file. It's set to a relative path, which means
            // the file must be in the same folder as this HTML file.
            const jokesJsonUrl = './jokes.json';

            // A variable to hold our jokes data. It's initialized to null to show it's "loading".
            let jokesData = null;

            // This async function fetches the JSON data from the specified URL.
            async function fetchJokesData() {
                try {
                    // Start a loading message.
                    resultDisplay.textContent = 'Loading joke data...';
                    resultDisplay.classList.add('bg-slate-700', 'text-slate-300');

                    // Fetch the data from the URL.
                    const response = await fetch(jokesJsonUrl);
                    
                    // Check if the response was successful.
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    // Parse the JSON and store it.
                    jokesData = await response.json();
                    
                    // Clear the loading message.
                    resultDisplay.textContent = '';
                    resultDisplay.classList.remove('bg-slate-700', 'text-slate-300');

                    console.log("Jokes data loaded successfully.");
                } catch (error) {
                    // Log the error to the console for debugging.
                    console.error("Failed to load jokes data:", error);
                    jokesData = []; // Default to an empty array on error to prevent app from breaking.
                    resultDisplay.textContent = 'Failed to load joke data. Please ensure the "jokes.json" file is in the same directory and is accessible.';
                    resultDisplay.classList.remove('bg-slate-700', 'text-slate-300');
                    // Changed the background to a red tone for the error message.
                    resultDisplay.classList.add('bg-red-900', 'text-red-300');
                }
            }

            // === 2. DOM Element Selection ===
            const videoIdInput = document.getElementById('videoIdInput');
            const checkButton = document.getElementById('checkButton');
            const resultDisplay = document.getElementById('resultDisplay');
            const editorButton = document.getElementById('editorButton');
            const jsonEditorModal = document.getElementById('jsonEditorModal');
            const jsonEditorTextarea = document.getElementById('jsonEditorTextarea');
            const saveButton = document.getElementById('saveButton');
            const closeButton = document.getElementById('closeButton');
            const editorMessage = document.getElementById('editorMessage');

            // === 3. Main Functionality: Video Check ===
            // Event listener for the "Check Video" button click.
            checkButton.addEventListener('click', () => {
                const videoId = videoIdInput.value.trim();
                resultDisplay.className = 'text-lg font-semibold text-center p-4 rounded-lg transition-all duration-300';
                
                if (videoId === '') {
                    resultDisplay.textContent = 'Please enter a video ID.';
                    resultDisplay.classList.add('bg-red-900', 'text-red-300');
                    return;
                }

                // Check if the data has been loaded before trying to search.
                if (!jokesData) {
                    resultDisplay.textContent = 'Data is still loading. Please wait a moment.';
                    resultDisplay.classList.add('bg-yellow-900', 'text-yellow-300');
                    return;
                }

                // Find the video entry in our data.
                const videoEntry = jokesData.find(video => video.id.toLowerCase() === videoId.toLowerCase() || video.title.toLowerCase().includes(videoId.toLowerCase()));

                if (videoEntry) {
                    // Only show the joke if it has been identified.
                    if (videoEntry.isIdentified) {
                        const jokeText = videoEntry.joke ? videoEntry.joke : "";
                        let displayContent = `Joke identified for video "${videoEntry.title}".`;
                        if (jokeText) {
                            displayContent += `<br>Joke: ${jokeText}`;
                        }
                        if (videoEntry.date_discovered) {
                            displayContent += `<br>Date Discovered: ${videoEntry.date_discovered}`;
                        }
                        // Add the new "discovered by" field to the display before "Time After Release"
                        if (videoEntry.discovered_by) {
                            displayContent += `<br>Discovered By: ${videoEntry.discovered_by}`;
                        }
                        if (videoEntry.time_after_release) {
                            displayContent += `<br>Time After Release: ${videoEntry.time_after_release}`;
                        }
                        resultDisplay.innerHTML = displayContent;
                        resultDisplay.classList.remove('bg-slate-700');
                        resultDisplay.classList.add('bg-green-900', 'text-green-300');
                    } else {
                        // If not identified, the message doesn't include the joke text.
                        resultDisplay.textContent = `Joke has NOT been identified for video "${videoEntry.title}".`;
                        resultDisplay.classList.remove('bg-slate-700');
                        resultDisplay.classList.add('bg-red-900', 'text-red-300'); 
                    }
                } else {
                    resultDisplay.textContent = `No entry found for video ID or title "${videoId}".`;
                    resultDisplay.classList.add('bg-red-900', 'text-red-300');
                }
            });

            // === 4. JSON Editor Functionality ===
            const unlockKey = 'modificaeditor';
            let typedString = '';
            
            // Event listener to check for the secret phrase to unlock the editor button.
            document.addEventListener('keydown', (e) => {
                // Get the typed key and convert to lowercase for case-insensitive matching.
                const key = e.key.toLowerCase();
                
                // Append the typed key to our tracking string.
                typedString += key;

                // Keep the string from growing indefinitely by only keeping the last part.
                if (typedString.length > unlockKey.length) {
                    typedString = typedString.slice(-unlockKey.length);
                }

                // If the typed string matches the unlock key, show the button.
                if (typedString === unlockKey) {
                    editorButton.classList.remove('hidden');
                    typedString = ''; // Reset the typed string so the button only appears once per typing.
                }
            });

            // Event listener to open the modal when the editor button is clicked.
            editorButton.addEventListener('click', () => {
                // Populate the textarea with the current jokes data, formatted for readability.
                jsonEditorTextarea.value = JSON.stringify(jokesData, null, 2);
                jsonEditorModal.style.display = 'flex'; // Show the modal.
            });

            // Event listener for the save button inside the modal.
            saveButton.addEventListener('click', () => {
                try {
                    // Attempt to parse the JSON from the textarea.
                    const newJokesData = JSON.parse(jsonEditorTextarea.value);
                    
                    // Basic validation to ensure it's an array.
                    if (Array.isArray(newJokesData)) {
                        // The embedded data is a const, so we can't change it. We'll just alert the user.
                        // You would need to use a server to actually save changes permanently.
                        editorMessage.textContent = 'Data saved locally for this session. To save permanently, you would need a back-end server.';
                        editorMessage.classList.remove('text-red-400');
                        editorMessage.classList.add('text-green-400');
                        setTimeout(() => {
                            jsonEditorModal.style.display = 'none'; // Hide the modal after a short delay.
                        }, 1000);
                    } else {
                        throw new Error('JSON is not a valid array.');
                    }
                } catch (error) {
                    // Display an error message if parsing fails.
                    editorMessage.textContent = `Invalid JSON: ${error.message}`;
                    editorMessage.classList.add('text-red-400');
                }
            });

            // Event listener to close the modal.
            closeButton.addEventListener('click', () => {
                jsonEditorModal.style.display = 'none';
                editorMessage.textContent = ''; // Clear any previous error messages.
            });

            // Immediately load the jokes data when the page loads.
            fetchJokesData();

        })();
    </script>

</body>
</html>
